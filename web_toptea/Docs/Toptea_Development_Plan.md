Toptea 新一代业务系统：完整开发与合规实施计划书

版本： 1.0
日期： 2025-10-29

一、 项目核心架构与开发约束（强制性基线）

1.1 目录隔离原则

强制要求： 所有后端逻辑必须按项目归类到专属目录中。

示例： POS 系统的后端核心文件应位于 pos_backend 目录，其 API 位于 pos/api 目录。

禁止： 绝不能与其他项目（如 cpsys 或 bms）的代码和文件混用。

1.2 同源 API 调用原则

强制要求： 绝对禁止跨域名 API 调用。

要求： 所有前端系统（如 store.toptea.es/pos/ 的 POS）必须且只能调用其自身域名下的 API（即 store.toptea.es/pos/api/...）。

1.3 代码格式约束

强制要求： 提供的代码不允许有任何的折叠。必须是完整、展开的代码。

1.4 开发文档规范

强制要求： 开发文档必须放在根目录下的 docs 目录中，以保持根目录整洁。

1.5 HTML 样式标准

强制要求： 当前设计的 HTML 样式将作为未来所有 Toptea 后端系统的标准。

1.6 网站空间目录布局

总部 (HQ) 站点：

物理路径： /web_toptea/hq/hq_html/html/ （此目录为网络可见）

访问域名： hq.toptea.es

说明： 此目录对应总部后台 CPSYS、BMS 等系统的前端文件。

门店 (Store) 站点：

物理路径： /web_toptea/store/store_html/html/ （此目录为网络可见）

访问域名： store.toptea.es

说明： 此目录对应门店端 POS、KDS、Staff 等系统的前端文件。

非公网目录：

物理路径： /web_toptea/、/web_toptea/hq/、/web_toptea/hq/hq_html/、/web_toptea/store/、/web_toptea/store/store_html/ 均为网络不可见目录，应用于存放后端源代码、配置文件、日志等敏感信息。

1.7 数据传输加密 (TLS/SSL)

要求： 所有前端（POS, BMS, KDS）与后端 API 之间的数据传输必须使用 TLS/SSL 加密（即使用 https）。

标准： 确保使用最新且安全的 TLS 协议版本。

二、 POS 终端特定要求与 UX/UI 约束

2.1 禁用系统对话框

强制要求： POS 前端不可使用系统的原生对话框（如 alert(), confirm()）。

替代： 必须使用美观且风格统一的自定义模态框或 Toast 提示。

2.2 访问环境要求

强制要求： POS 端、KDS 端将通过套壳 APK（WebView 或类似容器）访问。

注意事项： 必须确保系统在 WebView 环境下兼容性良好，特别是打印功能、支付接口调用和本地存储的稳定性。

2.3 前端数据持久化

强制要求： 必须利用本地存储（如 localStorage 或 IndexedDB）来支持离线功能和用户偏好设置（如左右手模式、语言）。

2.4 左右手模式实现

要求： 必须确保左右手模式的切换逻辑（righty-mode / lefty-mode CSS 类切换）功能正常，且状态能被正确持久化。

2.5 交易数据

强制要求： 所有核心业务数据（商品、价格、活动）必须从后端获取，禁止前端硬编码。

三、 RGPD 合规与安全性强制性要求

3.1 数据存储与加密合规

密码加密存储（强制要求）：

所有用户密码必须在存储于数据库时进行单向强加密。

标准： 采用 bcrypt 或 Argon2 等行业推荐的慢哈希算法，绝不存储明文密码。

敏感配置数据保护：

对所有涉及支付网关连接、第三方服务密钥等敏感配置信息进行加密存储。

标准： 使用成熟的对称加密算法（如 AES-256），并将密钥安全隔离管理。

支付数据最小化原则（RGPD 核心）：

要求： POS 系统禁止收集和存储任何完整的客户银行卡号或 CVV 码。

处理： 仅存储由支付网关返回的去标识化（Tokenized）交易引用码，用于订单查询和对账。

3.2 API 鉴权与访问控制合规

强制鉴权机制实施：

所有访问 Toptea 核心数据的 API 都必须进行强制性身份验证。

机制： 实施基于 Token 的认证方案（如 JWT 或 Session Token）。

Token 生命周期管理：

设定合理的 Token 有效期（例如，短时生命周期），并实施 Token 刷新机制，降低 Token 泄露的风险。

最小权限原则（RBAC）：

系统所有用户（包括 API 账户）的访问权限必须严格限制在其工作职责必需的最小范围内。

实现： 建立基于角色的访问控制模型（RBAC）。

3.3 交易完整性与审计合规

合规性集成（强制）：

订单结算必须正确集成 TicketBAI / Veri*Factu 双合规系统框架，在交易完成时生成哈希链和合规二维码。

交易数据的不可篡改性：

确保已完成的订单数据和财务票据在数据库中禁止被修改或删除。

实现： 仅允许追加操作或记录所有修改历史（审计日志），以维护交易的完整性链条。

审计追踪与日志记录：

记录所有敏感操作（如：价格修改、退款、权限变更）的详细审计日志。

内容： 日志应包含操作者、操作时间、操作类型和受影响的数据。

API 输入验证：

对所有进入后端的 API 数据，进行严格的服务器端输入验证和清理，以防止 SQL 注入和 XSS 攻击。

四、 系统现状与已完成模块清单

4.1 三大基础系统

CPSYS (总部后台管理系统)： 完成基础架构搭建、物料/配方/供应商/单位管理、用户认证与权限框架、核心数据表设计。

KDS (厨房出品系统)： 完成订单接收、状态管理、双编码杯贴打印逻辑、离线模式支持。

EXPSYS (效期管理系统)： 完成物料效期数字化管理工具实现。

4.2 当前阶段已完成任务 (POS/BMS 深度开发)

POS 核心交易链路： 完成点餐、商品定制化、订单汇总、订单保存等主流程。

POS 合规系统集成： 完成 TicketBAI / Veri*Factu 双合规系统框架集成。

POS 统一营销活动引擎： 实现买一送一 (BOGO)、指定商品折扣和优惠码等核心促销逻辑。

POS 高级支付流程： 重构支付模态框，支持多方式、拆分支付，并实时计算找零和记录平台参考码。

POS 前端 UI/UX： 支持中/西双语切换、左右手模式，UI 统一优化。

BMS 营销活动管理模块： 提供了动态 UI 用于创建和管理 POS 支持的所有促销类型。

BMS 基础数据管理： 完成 POS 所需的商品、分类、规格、定价等基础数据的管理能力。

BMS 票据查询与管理： 实现了票据列表查询及查看完整票据详情（含合规数据）。

POS 挂起单 (Order Holds) 功能： 已完成从数据库、后端API到前端集成的全链路开发。

POS 交接班与日报表 (Z-Out)： 已完成核心功能修复、增强及打印基础集成。

小票格式设置功能： BMS后台模板管理与POS端模板同步、解析逻辑已开发完成。

五、 当前风险与待弥补不足（详细描述）

5.1 运营工具欠缺 (高操作风险)

挂单功能缺失：

描述： 门店在高峰期需要临时保存顾客订单（例如，顾客去取钱、等待同伴），以便立即处理下一位顾客。

风险： 缺乏此功能，操作员要么手动记录，要么取消订单，导致操作流程中断和数据丢失。

【状态更新】：此功能已开发完成，本风险已缓解。

交接班与日报表缺失（Z-Out）：

描述： 缺乏正式的交接班流程来清点现金、核对交易、打印财务日报。

风险： 存在重大财务风险，现金差异难以追踪，财务数据无法及时、准确地与后端核对。

【状态更新】：此功能核心部分已开发完成并修复重大Bug，本风险已显著降低。

订单查询与退款流程缺失：

描述： 缺乏快速查找历史订单和处理退款请求的流程。

风险： 影响客户服务体验。

5.2 数据完整性监控 (高维护风险)

系统级错误日志记录缺失：

描述： 必须在关键业务节点（如订单创建、支付失败、KDS/打印机通信失败）记录详细的错误日志。

风险： 缺乏日志将无法快速定位问题原因，严重影响故障恢复时间。

性能基线要求缺失：

描述： 需要为核心 API 制定明确的性能指标（例如，“结账 API 响应时间必须小于 300 毫秒”）。

风险： 缺乏基线导致系统负荷增加时响应变慢，但无法衡量和优化。

数据库事务强制性不足：

描述： 需强制所有核心交易（如订单创建和库存扣减）使用数据库事务。

风险： 缺乏事务保证将导致数据不一致，造成严重的财务损失和业务混乱。

5.3 国际化/多语言与扩展性

统一的国际化机制缺失 (i18n)：

描述： 所有前端和后端返回的文本内容都需要通过统一的 i18n 资源文件进行管理。

风险： 目前可能存在文本硬编码，导致未来新增语言或修改文案时，维护成本极高。

可配置的文本内容能力不足：

描述： 某些非交易文本（如小票页脚的感谢语）应可由 BMS 后台配置。

风险： 缺乏灵活的配置，导致门店无法根据自身需求快速调整宣传或通知内容。

5.4 安全性要求待实施 (极高风险)

描述： 上述第三章（RGPD 合规与安全性强制性要求）中规定的具体加密、鉴权、防攻击措施尚未在代码层面完全实施。

风险： 系统面临数据泄露、未授权访问和恶意攻击的高风险，不符合RGPD法律要求。

六、 后续开发计划任务清单（分阶段）

A. 阶段一：关键运营与安全基础 (优先级：最高)

POS 核心运营功能 - 【挂起单 (Order Holds)】 - 【状态： 已完成】

描述： 支持订单临时保存和恢复，解决高峰期操作流程中断问题。

实现内容：

数据库： 已创建 pos_held_orders 表用于持久化存储。

后端 API： 已开发 pos_hold_handler.php，提供保存、读取列表（支持排序）、恢复并删除的全套接口。

前端集成： 已实现完整的POS前端操作界面与UI反馈。

后续步骤： 监控线上使用情况，优化列表加载性能。

POS 核心运营功能 - 【交接班与日报表 (Z-Out)】 - 【状态： 核心功能与打印基础 已完成】

描述： 确保每日财务结算和数据准确性，并提供打印能力。

实现内容：

核心功能修复与增强： 已彻底修复“日结死循环”、“收款方式汇总计算错误”等重大Bug，并完善漏结检查逻辑。

打印功能集成： 日结完成后，界面已提供“打印报告”按钮，可结合模板数据模拟生成格式化打印内容。

后续步骤： 完成与物理打印机的最终联调测试。

小票格式设置功能 (BMS & POS) - 【状态： 基础框架与后台 已完成】

第一步：模板设计与后端配置（BMS 模块） - 【状态： 已完成】

1.1 数据存储层准备： 已创建 pos_print_templates 表，用于存储模板配置JSON。

1.2 模板管理后端服务： 已开发 print_template_handler.php API，实现对模板的CRUD操作。

1.3 BMS 配置界面构建： 已在总部后台新增“打印模板管理”页面，支持JSON编辑与“模板可用变量”参考。

1.4 模板配置基线： 已为“日报表”、“顾客小票”、“厨房单”创建并插入默认模板JSON。

第二步：POS 前端打印功能设置（打印执行与解析） - 【状态： 核心逻辑 已完成】

2.1 模板同步服务： POS终端启动时已实现自动同步最新模板。

2.2 本地缓存机制： 已实现模板的本地缓存。

2.3 核心指令解析器开发： 已开发解析模块，可接收订单数据与模板JSON，并模拟生成格式化打印指令。

2.4 交易流程集成与测试： 打印逻辑已集成至日结流程，并完成初步模拟测试。

后续步骤： 完成POS前端 api.js, main.js, state.js, eod.js 等文件的更新，以完全集成新功能；进行物理打印机全场景测试。

安全性实施 (首要任务) - 【状态： 待开始 / 下一优先级】

描述： 制定并实施敏感数据加密标准和 API Token 刷新/过期机制。在所有 API 层面部署输入验证，防止常见 Web 攻击（详见计划书第三章）。

后续安排： 鉴于核心运营功能已就绪，此任务应作为阶段一剩余的最高优先级任务立即启动。

B. 阶段二：数据智能与管理深度 - 【状态： 待开始】

BMS 高级报表中心：

构建报表 API，提供销售、利润、物料消耗等可视化数据分析。

开发历史订单查询和筛选功能。

系统监控与日志：

建立统一的错误日志记录和上报机制（特别是 POS 端和 KDS 端的失败事件）。

确定 API 性能基线，并实现性能监控。

订单管理优化：

完善 POS 订单管理与查询模块，支持对已完成订单进行查看和退款操作。

C. 阶段三：全面集成与系统联动 - 【状态： 待开始】

库存联动模块：

设计并实现 BMS 后台的库存管理界面。

实现 POS 订单提交时自动扣减库存的业务逻辑（必须使用数据库事务保证原子性）。

国际化 i18n 机制：

将所有硬编码或散乱的文本资源迁移到统一的国际化资源文件中进行管理和调用。

七、 项目目录结构规范

本章节将项目逻辑结构与 【1.6 网站空间目录布局】 中描述的物理服务器路径进行对应。

7.1 逻辑根目录与服务器路径映射

逻辑根目录 (/) 在服务器上对应于 /web_toptea/ 目录（网络不可见）。

docs/ - 【强制】 - 存放所有开发文档。对应于服务器路径 /web_toptea/docs/。

src/ - 存放后端核心逻辑、配置文件和库。对应于服务器路径 /web_toptea/src/ (网络不可见)。

html/ - 此逻辑目录已被 【1.6 网站空间目录布局】 中的具体路径所取代。原计划存放的公网前端文件，现应根据系统分别部署至 /web_toptea/hq/hq_html/html/ 和 /web_toptea/store/store_html/html/。

logs/ - 存放系统级错误日志、安全审计日志等。对应于服务器路径 /web_toptea/logs/ (网络不可见)。

config/ - 存放项目配置文件、环境配置、加密密钥等。对应于服务器路径 /web_toptea/config/ (网络不可见)。

7.2 后端核心逻辑目录 (/web_toptea/src/)

services/ - 存放可供所有子系统调用的核心服务逻辑（如加解密、日志记录、数据库连接）。

models/ - 存放所有数据库模型定义。

cpsys_backend/ - 独立存放总部后台管理系统（CPSYS）的后端控制器和业务逻辑。

bms_backend/ - 独立存放商业管理系统（BMS）的后端逻辑（如报表生成、模板配置）。

pos_backend/ - 【强制隔离】，独立存放 POS 终端的核心后端逻辑（如订单处理、支付回调）。

kds_backend/ - 独立存放 KDS 厨房系统的后端逻辑（如订单接收与状态更新）。

7.3 公网前端文件目录 (根据站点分离)

总部前端 (/web_toptea/hq/hq_html/html/)

访问域名： hq.toptea.es

index.html (总部登录/引导页)

cpsys/ (CPSYS 前端文件)

bms/ (BMS 前端文件)

门店前端 (/web_toptea/store/store_html/html/)

访问域名： store.toptea.es

index.html (门店登录/引导页)

pos/ (存放 POS 终端前端文件)

api/： 【强制要求】，此目录下存放 POS 终端必须调用的 API 入口脚本，确保同源调用。

kds/ (存放 KDS 厨房系统前端文件)

expsys/ (存放效期管理系统前端文件)